<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador de Fuga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .form-section { @apply bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-6; }
        .input-label { @apply block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1; }
        .input-field { @apply w-full rounded-lg border-gray-200 p-3 text-sm border focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen py-12 px-4">

    <div class="max-w-4xl mx-auto">
        <div class="text-center mb-10">
            <h1 class="text-3xl font-extrabold text-slate-800">Analizador Predictivo de Fuga</h1>
            <p class="text-slate-500 mt-2">Introduce los datos del cliente para evaluar el riesgo de abandono</p>
        </div>

        <form id="churnForm">
            <div class="form-section">
                <h2 class="text-lg font-bold text-slate-700 mb-4 flex items-center">
                    <span class="bg-indigo-100 text-indigo-600 p-2 rounded-lg mr-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    </span>
                    Perfil del Cliente
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="input-label">Género</label>
                        <select name="GENERO" class="input-field mb-10 w-1/2 p-2">
                            <option value="M">Masculino</option>
                            <option value="F">Femenino</option>
                        </select>
                    </div>
                    <div>
                        <label class="input-label">Edad</label>
                        <input type="number" name="EDAD" required class="input-field mb-10 w-1/2 p-2" placeholder="Ej: 35">
                    </div>
                    <div>
                        <label class="input-label">Estado Civil</label>
                        <select name="E_CIVIL" class="input-field mb-10 w-1/2 p-2">
                            <option value="SOL">Soltero/a</option>
                            <option value="CAS">Casado/a</option>
                            <option value="VIU">Viudo/a</option>
                            <option value="SEP">Separado/a</option>
                        </select>
                    </div>
                    <div>
                        <label class="input-label">Nivel Educativo</label>
                        <select name="NIV_EDUC" class="input-field mb-10 w-1/2 p-2">
                            <option value="BAS">Básico</option>
                            <option value="MED">Medio</option>
                            <option value="TEC">Técnico</option>
                            <option value="UNV">Universitario</option>
                            <option value="EUN">Postgrado</option>
                        </select>
                    </div>
                    <div>
                        <label class="input-label">Ciudad</label>
                        <input type="text" name="CIUDAD" required class="input-field mb-10 w-1/2 p-2" placeholder="Ej: SANTIAGO">
                    </div>
                    <div>
                        <label class="input-label">Seguro</label>
                        <select name="SEGURO" class="input-field mb-10 w-1/2 p-2">
                            <option value="NO">No</option>
                            <option value="SI">Sí</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h2 class="text-lg font-bold text-slate-700 mb-4 flex items-center">
                    <span class="bg-emerald-100 text-emerald-600 p-2 rounded-lg mr-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 8c-1.657 0-3 1.343-3 3s1.343 3 3 3 3-1.343 3-3-1.343-3-3-3z"></path><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2z"></path></svg>
                    </span>
                    Información Financiera
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div>
                        <label class="input-label">Renta Mensual</label>
                        <input type="number" name="RENTA" required class="input-field mb-10 w-1/2 p-2">
                    </div>
                    <div>
                        <label class="input-label">Monto Solicitado</label>
                        <input type="number" name="MONTO" required class="input-field mb-10 w-1/2 p-2">
                    </div>
                    <div>
                        <label class="input-label">Cód. Oficina</label>
                        <input type="number" name="COD_OFI" required class="input-field mb-10 w-1/2 p-2">
                    </div>
                    <div>
                        <label class="input-label">Cód. Comuna</label>
                        <input type="number" name="COD_COM" required class="input-field mb-10 w-1/2 p-2">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h2 class="text-lg font-bold text-slate-700 mb-4 flex items-center">
                    <span class="bg-amber-100 text-amber-600 p-2 rounded-lg mr-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    </span>
                    Histórico de Deuda (Evolución Mensual)
                </h2>
                <div class="grid grid-cols-2 md:grid-cols-7 gap-3 mb-6">
                    <div><label class="input-label">Marzo</label><input type="number" name="D_Marzo" value="0" class="input-field p-2 w-3/4"></div>
                    <div><label class="input-label">Abril</label><input type="number" name="D_Abril" value="0" class="input-field p-2 w-3/4"></div>
                    <div><label class="input-label">Mayo</label><input type="number" name="D_Mayo" value="0" class="input-field p-2 w-3/4"></div>
                    <div><label class="input-label">Junio</label><input type="number" name="D_Junio" value="0" class="input-field p-2 w-3/4"></div>
                    <div><label class="input-label">Julio</label><input type="number" name="D_Julio" value="0" class="input-field p-2 w-3/4"></div>
                    <div><label class="input-label">Agosto</label><input type="number" name="D_Agosto" value="0" class="input-field p-2 w-3/4"></div>
                    <div><label class="input-label">Sept.</label><input type="number" name="D_Septiembre" value="0" class="input-field p-2 w-3/4"></div>
                </div>
                <div class="w-full md:w-1/3">
                    <label class="input-label">Meses en Morosidad</label>
                    <input type="number" name="M_MOROSO" value="0" class="input-field mb-10 w-1/2 p-2">
                </div>
            </div>

            <button type="submit" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-indigo-700 shadow-lg hover:shadow-indigo-200 transition-all duration-300">
                GENERAR PREDICCIÓN
            </button>
        </form>

        <div id="resultContainer" class="hidden mt-8 p-6 rounded-xl border-2 transition-all duration-500 transform scale-95 opacity-0">
            <div class="flex items-center justify-between">
                <div>
                    <h3 id="resultTitle" class="text-xl font-bold"></h3>
                    <p id="resultDetails" class="mt-1 opacity-90"></p>
                </div>
                <div id="resultScore" class="text-3xl font-black"></div>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('churnForm');
        const resCont = document.getElementById('resultContainer');
        const resTitle = document.getElementById('resultTitle');
        const resDet = document.getElementById('resultDetails');
        const resScore = document.getElementById('resultScore');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Transformación de tipos para cumplir con el esquema del dataset 
            const payload = {
                ...data,
                RENTA: parseInt(data.RENTA),
                EDAD: parseFloat(data.EDAD),
                COD_OFI: parseInt(data.COD_OFI),
                COD_COM: parseFloat(data.COD_COM),
                D_Marzo: parseInt(data.D_Marzo),
                D_Abril: parseInt(data.D_Abril),
                D_Mayo: parseInt(data.D_Mayo),
                D_Junio: parseInt(data.D_Junio),
                D_Julio: parseInt(data.D_Julio),
                D_Agosto: parseInt(data.D_Agosto),
                D_Septiembre: parseInt(data.D_Septiembre),
                M_MOROSO: parseInt(data.M_MOROSO),
                MONTO: parseInt(data.MONTO)
            };

            // Animación de carga
            resCont.className = "mt-8 p-6 rounded-xl border-2 bg-white border-slate-200 block opacity-100 scale-100";
            resTitle.innerText = "Procesando datos...";
            resDet.innerText = "Consultando el modelo de Inteligencia Artificial";
            resScore.innerText = "";

            try {
                const response = await fetch('http://localhost:8000/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('Error en la API');

                const result = await response.json();
                const prob = (result.probabilidades[1] * 100).toFixed(1);
                
                // Mostrar resultado final basado en la predicción 
                if (result.prediccion === 1) {
                    resCont.className = "mt-8 p-6 rounded-xl border-2 bg-red-50 border-red-200 block opacity-100 scale-100 text-red-900";
                    resTitle.innerText = "⚠️ ALTA PROBABILIDAD DE FUGA";
                    resDet.innerText = "El modelo detecta patrones de comportamiento críticos.";
                } else {
                    resCont.className = "mt-8 p-6 rounded-xl border-2 bg-emerald-50 border-emerald-200 block opacity-100 scale-100 text-emerald-900";
                    resTitle.innerText = "✅ CLIENTE CONSOLIDADO";
                    resDet.innerText = "No se detecta riesgo inminente de abandono.";
                }
                resScore.innerText = `${prob}%`;

            } catch (error) {
                resCont.className = "mt-8 p-6 rounded-xl border-2 bg-gray-100 border-gray-300 block opacity-100 scale-100";
                resTitle.innerText = "Error de conexión";
                resDet.innerText = "No se pudo contactar con el servidor FastAPI.";
            }
        });
    </script>
</body>
</html>